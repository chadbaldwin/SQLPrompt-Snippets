{
  "id": "a104c89f-4043-472c-b72e-1cf667fa2cbe",
  "prefix": "qGenerateTempTable",
  "description": "Generate a temp table using the query from the clipboard",
  "body": "\n-- Public Gist: https://gist.github.com/chadbaldwin/292977a1c20c314bc67899746a763f4e\n\nDECLARE @sql nvarchar(MAX) = N'\n\t/*\n\tEnter your query here to generate output\n\t*/\n';\n\nSELECT REPLACE((\n\tSELECT CONCAT(\n\t\t\t  IIF(x.ColOrder = 1, 'CREATE TABLE #tmpTable ({{br}}', NULL)\t\t\t\t-- If it's the first column, add create table statement\n\t\t\t, CHAR(9), x.ColName\t\t\t\t\t\t\t\t\t\t\t\t\t\t-- Indent each column by 1 tab\n\t\t\t, REPLICATE(CHAR(9), CEILING((x.MaxColNameLen - LEN(x.ColName)) / 4.0))\t\t-- Add tabs after column name so that data type lines up\n\t\t\t, x.ColType\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t-- Data type of column\n\t\t\t, REPLICATE(CHAR(9), CEILING((x.MaxTypeNameLen - LEN(x.ColType)) / 4.0))\t-- Add tabs after data type so that NULL/NOT NULL lines up\n\t\t\t, IIF(x.is_nullable = 1, CHAR(9) + 'NULL', 'NOT NULL'), ',{{br}}'\t\t\t-- Add an extra tab to align 'NULL'\n\t\t\t, IIF(x.ColOrder = MAX(x.ColOrder) OVER (), ');', NULL)\t\t\t\t\t\t-- If it's the last column, close up\n\t\t)\n\tFROM (\n\t\tSELECT y.ColName, ColType = x.system_type_name, ColOrder = x.column_ordinal, x.is_nullable\n\t\t\t, MaxColNameLen = MAX(LEN(y.ColName)) OVER () + (4-(MAX(LEN(y.ColName)) OVER () % 4))\n\t\t\t, MaxTypeNameLen = MAX(LEN(x.system_type_name)) OVER () + (4-(MAX(LEN(x.system_type_name)) OVER () % 4))\n\t\tFROM sys.dm_exec_describe_first_result_set(@sql, NULL, 1) x\n\t\t\tCROSS APPLY (\n\t\t\t\tSELECT TypeName = CONCAT(x.system_type_name\n\t\t\t\t\t\t,\tCASE\n\t\t\t\t\t\t\t\tWHEN x.system_type_name IN ('datetime2', 'time')\tTHEN IIF(x.scale = 7, NULL, CONCAT('(', x.scale, ')')) --scale of (7) is the default so it can be ignored, (0) is a valid value\n\t\t\t\t\t\t\t\tWHEN x.system_type_name IN ('datetimeoffset')\t\tTHEN CONCAT('(', x.scale, ')')\n\t\t\t\t\t\t\t\tWHEN x.system_type_name IN ('decimal', 'numeric')\tTHEN CONCAT('(', x.[precision], ',', x.scale,')')\n\t\t\t\t\t\t\t\tWHEN x.system_type_name IN ('nchar', 'nvarchar')\tTHEN IIF(x.max_length = -1, '(MAX)', CONCAT('(', x.max_length/2, ')'))\n\t\t\t\t\t\t\t\tWHEN x.system_type_name IN ('char', 'varchar')\t\tTHEN IIF(x.max_length = -1, '(MAX)', CONCAT('(', x.max_length, ')'))\n\t\t\t\t\t\t\t\tWHEN x.system_type_name IN ('binary', 'varbinary')\tTHEN IIF(x.max_length = -1, '(MAX)', CONCAT('(', x.max_length, ')'))\n\t\t\t\t\t\t\t\tELSE NULL\n\t\t\t\t\t\t\tEND)\n\t\t\t) dt\n\t\t\tCROSS APPLY (\n\t\t\t\tSELECT ColName = IIF(x.[name] IN ( -- Add sqare brackets only to reserved keywords or names containing unescaped characters\n\t\t\t\t\t\t\t\t\t\t'action','address','application','data','date','day','dayofyear','definition','deny','description','enabled','endpoint',\n\t\t\t\t\t\t\t\t\t\t'expiredate','filename','hash','index','level','location','message','minutes','month','monthname','name','or','order',\n\t\t\t\t\t\t\t\t\t\t'password','path','population','port','priority','provider','quarter','rank','read','replace','role','row','rowcount',\n\t\t\t\t\t\t\t\t\t\t'sequence','server','source','state','status','subject','text','trim','type','uid','url','user','value','version','weekday',\n\t\t\t\t\t\t\t\t\t\t'year','object_id','schema_id','type_desc','lock_escalation','durability','messages','weight'\n\t\t\t\t\t\t\t\t\t) OR x.[name] LIKE '%[^a-z0-9_#]%' OR x.[name] LIKE '[0-9]%', QUOTENAME(x.[name]), x.[name])\n\t\t\t) y\n\t\tWHERE x.is_hidden = 0\n\t) x\n\tORDER BY x.ColOrder\n\tFOR XML PATH ('')\n), '{{br}}', CHAR(13)+CHAR(10));"
}