{
  "id": "51def7c4-b109-4cd9-a1ef-2a670032431f",
  "name": "qJobSchedules",
  "prefix": "qJobSchedules",
  "description": "Job Schedules Query",
  "body": "SELECT JobName\t\t= j.[name]\n\t, Category\t\t= c.[name]\n\t, [Owner]\t\t= SUSER_SNAME(j.owner_sid)\n\t, [Enabled]\t\t= IIF(j.[enabled] = 1, 'Yes', 'No')\n\t, Scheduled\t\t= IIF(s.[enabled] = 1, 'Yes', 'No')\n\t, [Description]\t= NULLIF(j.[description], 'No description available.')\n\t, Occurs\t\t= CHOOSE(LOG(s.freq_type,2)+1,'Once', NULL, 'Daily', 'Weekly', 'Monthly', 'Monthly relative', 'When SQL Server Agent starts', 'Start whenever the CPU(s) become idle')\n\t, Occurs_detail\t= CHOOSE(LOG(s.freq_type,2)+1\n\t\t\t\t\t\t\t, NULL\n\t\t\t\t\t\t\t, NULL\n\t\t\t\t\t\t\t, CONCAT('Every ', s.freq_interval, ' day(s)')\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t--\"Every 10 day(s)\"\n\t\t\t\t\t\t\t, CONCAT('Every ', s.freq_recurrence_factor, ' weeks(s) on '\t\t\t\t\t\t\t\t\t\t\t\t--\"EVery 3 week(s) on SMT_T_S\"\n\t\t\t\t\t\t\t\t\t, IIF(s.freq_interval &  1 =  1, 'S', '_'), IIF(s.freq_interval &  2 =  2, 'M', '_')\n\t\t\t\t\t\t\t\t\t, IIF(s.freq_interval &  4 =  4, 'T', '_'), IIF(s.freq_interval &  8 =  8, 'W', '_')\n\t\t\t\t\t\t\t\t\t, IIF(s.freq_interval & 16 = 16, 'T', '_'), IIF(s.freq_interval & 32 = 32, 'F', '_')\n\t\t\t\t\t\t\t\t\t, IIF(s.freq_interval & 64 = 64, 'S', '_')\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t, CONCAT('Day ', s.freq_interval,' of every ',s.freq_recurrence_factor,' month(s)')\t\t\t\t\t\t\t--\"Day 5 of every 3 months(s)\"\n\t\t\t\t\t\t\t, CONCAT('The '\n\t\t\t\t\t\t\t\t\t, CHOOSE(LOG(s.freq_relative_interval,2)+1, '1st','2nd','3rd','4th','Last'), ' '\t\t\t\t\t--\"The 1st\"\n\t\t\t\t\t\t\t\t\t, CHOOSE(s.freq_interval, 'Sun','Mon','Tue','Wed','Thu','Fri','Sat','Day','Weekday','Weekend Day')\t--\"Sun\"\n\t\t\t\t\t\t\t\t\t, ' of every ', s.freq_recurrence_factor, ' month(s)'\t\t\t\t\t\t\t\t\t\t\t\t--\"of every 3 months(s)\"\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t)\n\t, Frequency\t\t= 'Occurs ' + CHOOSE(LOG(NULLIF(s.freq_subday_type,0),2)+1\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t--\"Occurs\"\n\t\t\t\t\t\t\t\t\t\t, CONCAT('once at ', x.StartTime)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t--\"once at 04:00:00\"\n\t\t\t\t\t\t\t\t\t\t, REPLACE(y.FrequencyString, '#interval#', 'Second')\n\t\t\t\t\t\t\t\t\t\t, REPLACE(y.FrequencyString, '#interval#', 'Minute')\n\t\t\t\t\t\t\t\t\t\t, REPLACE(y.FrequencyString, '#interval#', 'Hour')\n\t\t\t\t\t\t\t\t\t)\n\t, AvgDuration\t= jh.AvgDuration\n\t, Next_Run_Date\t= CONVERT(datetime, IIF(js.next_run_date = 0, '1900-01-01', CONVERT(char(8), js.next_run_date, 112) + ' ' + x.NextRunTime))\nFROM msdb.dbo.sysjobs j\n\tLEFT JOIN msdb.dbo.sysjobschedules js ON j.job_id = js.job_id\n\tLEFT JOIN msdb.dbo.sysschedules s ON js.schedule_id = s.schedule_id\n\tJOIN msdb.dbo.syscategories c ON j.category_id = c.category_id\n\tLEFT JOIN (SELECT job_id, AvgDuration = AVG(DATEDIFF(ss, 0, CONVERT(time, STUFF(STUFF(RIGHT(CONCAT('000000', run_duration), 6), 5, 0, ':'), 3, 0, ':')))) FROM msdb.dbo.sysjobhistory WHERE step_id = 0 GROUP BY job_id) jh ON jh.job_id = j.job_id\n\tCROSS APPLY (SELECT StartTime\t= STUFF(STUFF(RIGHT(CONCAT('000000', s.active_start_time), 6), 5, 0, ':'), 3, 0, ':')\n\t\t\t\t\t, EndTime\t\t= STUFF(STUFF(RIGHT(CONCAT('000000', s.active_end_time\t), 6), 5, 0, ':'), 3, 0, ':')\n\t\t\t\t\t, NextRunTime\t= STUFF(STUFF(RIGHT(CONCAT('000000', js.next_run_time\t), 6), 5, 0, ':'), 3, 0, ':')\n\t\t\t\t) x\n\tCROSS APPLY (SELECT FrequencyString = CONCAT('every ',s.freq_subday_interval,' #interval#(s) between ',x.StartTime,' and ',x.EndTime)) y --\"every 4 #interval#(s) between 01:00:00 and 17:00:00\"\nORDER BY j.[name]",
  "placeholders": []
}